#!/bin/sh

syncrepo () {
    DIR="$1"
    CHANGES=$(git --git-dir "${DIR}/.git" --work-tree "${DIR}/" status --porcelain)
    echo "syncing the following changes to $DIR"
    echo ""
    echo "$CHANGES"
    echo ""

    cd "$DIR" || return

    git add --all
    git commit -m "Automated sync
$CHANGES"
    git pull --rebase
    git push

    # in case something goes wrong
    git restore --staged .
}

#[ "$#" -lt 1 ] && echo "No repository specified" && exit 1
CUR_DIR=$(pwd)

ARGS="$@"
[ -z "$ARGS" ] && ARGS=$(pwd)
for DIR in $ARGS; do

    echo ""

    # check if dir exists and is a git repository
    if [ ! -d "$DIR" ]; then
        echo "${DIR}/ not found"
        echo "skipping"
        continue
    elif [ ! -d "${DIR}/.git" ]; then
        echo "$DIR is not a git repository"
        echo "skipping"
        continue
    fi

    # convert relative path to absolute
    if ! echo "$DIR" | grep ^/ > /dev/null
    then
        DIR="$(pwd)/$DIR"
    fi

    # check for changes
    CHANGES=$(git --git-dir "${DIR}/.git" --work-tree "${DIR}/" ls-files -mo --exclude-standard)
    if [ -z "$CHANGES" ]; then
        echo "$DIR has no new changes"
        echo "skipping"
        continue
    fi

    syncrepo "$DIR"

done

cd "$CUR_DIR" || exit

exit 0
